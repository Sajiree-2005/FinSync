<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Finvoice Dashboard</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <header>
      <h1>Finvoice - AI Financial Assistant</h1>
      <p>Your personalized student finance dashboard</p>
    </header>

    <main class="container">
      <!-- Financial Health Score -->
      <section class="card">
        <h2>üí∞ Financial Health Score</h2>
        <div class="score">{{ health_score }}/100</div>
        <p>
          Based on your weekly spending patterns, income, and financial aid.
        </p>
      </section>

      <!-- Expense Mood Insights -->
      <section class="card">
        <h2>üòä Expense Mood Insights</h2>
        {% if mood_insights %}
        <ul>
          {% for insight in mood_insights %}
          <li>{{ insight }}</li>
          {% endfor %}
        </ul>
        {% else %}
        <p>No notable patterns detected yet.</p>
        {% endif %}
      </section>

      <!-- Fun Challenges -->
      <section class="card">
        <h2>üéØ Fun Financial Challenges</h2>
        {% if nudges %}
        <ul>
          {% for nudge in nudges %}
          <li>{{ nudge }}</li>
          {% endfor %}
        </ul>
        {% else %}
        <p>Great job! No immediate challenges.</p>
        {% endif %}
      </section>

      <!-- Previous Week Expenses -->
      <section class="card">
        <h2>üìä Previous Week Expenses</h2>
        <p><strong>Total Expenses: ‚Çπ{{ total_prev_week }}</strong></p>
        <table>
          <thead>
            <tr>
              <th>Category</th>
              <th>Amount (‚Çπ)</th>
            </tr>
          </thead>
          <tbody>
            {% for category, amount in expenses.items() %}
            <tr>
              <td>{{ category.replace("_", " ").title() }}</td>
              <td>
                {% if amount == amount|int %} {{ amount|int }} {% else %} {{
                '%.2f' % amount }} {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>

      <!-- Conditional Input Form -->
      <section class="card">
        <h2>‚úèÔ∏è Input Current Week Expenses</h2>
        <form method="POST">
          <label>Do you want to input your expenses?</label>
          <select name="use_input" id="use_input" onchange="toggleForm()">
            <option value="no" {% if not user_input_given %}selected{% endif %}>
              No, use historical averages
            </option>
            <option value="yes" {% if user_input_given %}selected{% endif %}>
              Yes, I want to input
            </option>
          </select>

          <div
            class="expense-inputs"
            id="expenseForm"
            style="display: none; margin-top: 15px"
          >
            <label>Weekly Income (‚Çπ):</label>
            <input type="number" name="monthly_income" step="0.01" />

            <label>Financial Aid (‚Çπ):</label>
            <input type="number" name="financial_aid" step="0.01" />

            {% for category in expenses.keys() %}
            <label>{{ category.replace('_', ' ').title() }} (‚Çπ):</label>
            <input type="number" name="{{ category }}" step="0.01" />
            {% endfor %}

            <button type="submit">Update Dashboard</button>
          </div>
        </form>
      </section>

      <!-- Voice Expense Logger -->
      <section class="card">
        <h2>üé§ Speak to Log Expense</h2>
        <p>Click below and say an expense like "Food 500"</p>
        <button onclick="startRecording()">Start Speaking</button>
      </section>
    </main>

    <script>
      function toggleForm() {
        var select = document.getElementById("use_input");
        var formDiv = document.getElementById("expenseForm");
        formDiv.style.display = select.value === "yes" ? "block" : "none";
      }

      window.onload = function () {
        var userInputGiven = "{{ user_input_given }}";
        if (userInputGiven === "True") {
          document.getElementById("expenseForm").style.display = "block";
        }
      };

      // -------- Voice Input --------
      function startRecording() {
        if (!("webkitSpeechRecognition" in window)) {
          alert(
            "Your browser does not support speech recognition. Use Chrome."
          );
          return;
        }

        let recognition = new webkitSpeechRecognition();
        recognition.lang = "en-US";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.start();

        recognition.onresult = function (event) {
          let spokenText = event.results[0][0].transcript;
          console.log("User said:", spokenText);

          fetch("/log_expense", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: spokenText }),
          })
            .then((res) => res.json())
            .then((data) => {
              alert(data.message);
              location.reload();
            });
        };
      }
    </script>
  </body>
</html>

